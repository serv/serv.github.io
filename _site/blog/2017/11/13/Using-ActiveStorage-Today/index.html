<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Using ActiveStorage Today (prior to Rails 5.2 release)</title>
  <meta name="description" content="DHH announced earlier in the year that Rails 5.2 will have a brand new component called ActiveStorage.ActiveStorage will manage user uploads such as photos d...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://jasonkim.ca/blog/2017/11/13/Using-ActiveStorage-Today/">
  <link rel="alternate" type="application/rss+xml" title="Jason Kim" href="http://jasonkim.ca/feed.xml">
</head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28018879-10', 'auto');
  ga('send', 'pageview');

</script>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Jason Kim</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Using ActiveStorage Today (prior to Rails 5.2 release)</h1>
    <p class="post-meta"><time datetime="2017-11-13T11:17:11-08:00" itemprop="datePublished">Nov 13, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><a href="http://weblog.rubyonrails.org/2017/7/15/this-week-in-rails-active-storage-telling-secrets-and-time-travelling/">DHH announced earlier in the year that Rails 5.2 will have a brand new component called ActiveStorage</a>.
ActiveStorage will manage user uploads such as photos directly by Rails.</p>

<p>Since then, a lot of progress has beenumade to integrate ActiveStorage to
Rails, and you can actually use ActiveStorage today. This blog will explore
the how you can update your Rails app to use ActiveStorage.</p>

<p><strong>Warning!</strong> You will be using the bleeding edge version of Rails and
there may be unforseen problems caused by it.</p>

<h2 id="setting-up-activestorage-for-rails">Setting up ActiveStorage for Rails</h2>

<h4 id="1-if-you-are-using-rails-version-before-5114-update-rails-to-5114-by-updating-your-gemfile">1. If you are using Rails version before 5.1.14, update Rails to 5.1.14 by updating your Gemfile</h4>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'~&gt; 5.1'</span><span class="p">,</span> <span class="s1">'&gt;= 5.1.4'</span></code></pre></figure>

<h4 id="2-run--bundle-update-rails">2. Run <code class="highlighter-rouge">$ bundle update rails</code></h4>

<h4 id="3-run--rails-appupdate-and-resolve-any-code-differences">3. Run <code class="highlighter-rouge">$ rails app:update</code> and resolve any code differences.</h4>

<h4 id="4-test-that-updating-to-5114-went-ok">4. Test that updating to <code class="highlighter-rouge">5.1.14</code> went ok.</h4>

<h4 id="5-now-we-want-to-update-rails-to-the-latest-bleeding-edge-version-in-the">5. Now we want to update rails to the latest bleeding edge version. In the</h4>
<p><code class="highlighter-rouge">Gemfile</code>, add the following lines.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">git_source</span><span class="p">(</span><span class="ss">:github</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">repo_name</span><span class="o">|</span>
  <span class="n">repo_name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">"</span> <span class="k">unless</span> <span class="n">repo_name</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
  <span class="s2">"https://github.com/</span><span class="si">#{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">.git"</span>
<span class="k">end</span>
<span class="o">...</span>
<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="ss">github: </span><span class="s1">'rails/rails'</span>
<span class="n">gem</span> <span class="s1">'arel'</span><span class="p">,</span> <span class="ss">git: </span><span class="s1">'https://github.com/rails/arel.git'</span>
<span class="n">gem</span> <span class="s1">'bootsnap'</span><span class="p">,</span> <span class="s1">'~&gt; 1.1'</span><span class="p">,</span> <span class="s1">'&gt;= 1.1.5'</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span></code></pre></figure>

<h4 id="6-run--bundle-update-rails">6. Run <code class="highlighter-rouge">$ bundle update rails</code></h4>

<h4 id="7--bundle-exec-rails--v-should-display-the-bleeding-edge-version">7. <code class="highlighter-rouge">$ bundle exec rails -v</code> should display the bleeding edge version,</h4>
<p><code class="highlighter-rouge">Rails 5.2.0.alpha</code>.</p>

<h4 id="8-update-the-application-configs-run--bundle-exec-rails-appupdate">8. Update the application configs. Run <code class="highlighter-rouge">$ bundle exec rails app:update</code>.</h4>

<h4 id="9-when-you-run--binrails---tasks-you-should-see">9. When you run, <code class="highlighter-rouge">$ ./bin/rails --tasks</code>, you should see,</h4>
<p><code class="highlighter-rouge">rails active_storage:install</code> as an available task.</p>

<h4 id="10-run--binrails-active_storageinstall-this-should-generate-a-migration-file">10. Run <code class="highlighter-rouge">$ ./bin/rails active_storage:install</code>. This should generate a migration file.</h4>

<h4 id="11-run--binrails-dbmigrate-now-our-sqlite-db-should-be-ready-to-support-activestorage">11. Run <code class="highlighter-rouge">$ ./bin/rails db:migrate</code>. Now our sqlite db should be ready to support ActiveStorage.</h4>

<h2 id="a-simple-image-uploading-example-using-activestorage">A simple image uploading example using ActiveStorage</h2>

<p>Up until now, we’ve been preparing Rails application to support ActiveStorage.
Now that the application is equipped with ActiveStorage, let us build a
simple feature that allows us to create a post with images
that uses ActiveStorage.</p>

<h4 id="1-generate-post-model--binrails-g-model-post">1. Generate post model. <code class="highlighter-rouge">$ ./bin/rails g model post</code>.</h4>

<h4 id="2-lets-add-two-columns-to-post-table-title-body-in-the-migration-file">2. Let’s add two columns to post table, <code class="highlighter-rouge">title</code>, <code class="highlighter-rouge">body</code> in the migration file.</h4>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># db/migrate/20171114063756_create_posts.rb</span>
<span class="k">class</span> <span class="nc">CreatePosts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:posts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:title</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">text</span> <span class="ss">:body</span>

     <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h4 id="3-lets-create-a-controller-for-posts-resource">3. Let’s create a controller for posts resource.</h4>
<p><code class="highlighter-rouge">$ ./bin/rails g controller posts</code></p>

<h4 id="4-and-add-posts-resources-routes-in-the-configroutesrb">4. And add posts resources routes in the <code class="highlighter-rouge">config/routes.rb</code>.</h4>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:posts</span>
<span class="k">end</span></code></pre></figure>

<h4 id="5-we-need-to-associate-post-with-images">5. We need to associate post with images.</h4>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many_attached</span> <span class="ss">:images</span>
<span class="k">end</span></code></pre></figure>

<h4 id="6-lets-add-code-for-index-show-and-create-actions">6. Let’s add code for index, show and create actions.</h4>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/controllers/posts_controller.rb</span>
<span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># we will display post form here</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>
  <span class="c1"># we will create post here</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">create!</span> <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:message</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:body</span><span class="p">)</span>
    <span class="n">post</span><span class="p">.</span><span class="nf">images</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:message</span><span class="p">][</span><span class="ss">:images</span><span class="p">])</span>
    <span class="n">redirect_to</span> <span class="n">post</span>
  <span class="k">end</span>
  <span class="c1"># we will display post with photo</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h4 id="7-add-the-index-view-for-the-post-with-the-following-code-this-will-display-upload-form-on-localhost3000posts-page">7. Add the index view for the post with the following code. This will display upload form on localhost:3000/posts page.</h4>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"># app/views/posts/index.html.erb
<span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">model: </span><span class="vi">@post</span><span class="p">,</span> <span class="ss">local: </span><span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">placeholder: </span><span class="s2">"Title"</span> <span class="cp">%&gt;</span><span class="nt">&lt;br&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_area</span> <span class="ss">:body</span> <span class="cp">%&gt;</span><span class="nt">&lt;br&gt;&lt;br&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">file_field</span> <span class="ss">:images</span><span class="p">,</span> <span class="ss">multiple: </span><span class="kp">true</span> <span class="cp">%&gt;</span><span class="nt">&lt;br&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">submit</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span></code></pre></figure>

<h4 id="8-now-lets-add-a-view-for-show-post">8. Now let’s add a view for show post.</h4>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"># app/views/posts/show.html.erb
<span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="vi">@post</span><span class="p">.</span><span class="nf">images</span><span class="p">.</span><span class="nf">first</span> <span class="cp">%&gt;</span></code></pre></figure>

<h4 id="9-try-submitting-a-photo-and-you-will-see-the-show-view-displays-the-image-you-just-submitted">9. Try submitting a photo and you will see the show view displays the image you just submitted.</h4>
<p>The image is currently stored locally in a
directory called <code class="highlighter-rouge">storage</code> in the app root level. But you can configure
this to push the files to cloud file storage systems like AWS S3, Google Cloud
and Azure.</p>

<p>As you can see, ActiveStorage presents a simplied file management system
that is well integrated with Rail’s ActiveRecord component.
As ActiveStorage matures, we should see majority of
file management use cases being covered by it.
While there are other file management systems out there for Rails, I suggest that
you consider ActiveStorage before you explore other options.</p>

<p>Also check out <a href="https://github.com/rails/rails/blob/master/activestorage/README.md">the documentation on ActiveStorage</a>.</p>

<p>You can see the final working code on the <a href="https://github.com/serv/rails-alpha-activestorage-example">github repo</a>.</p>

<p>I wanna thank <a href="https://twitter.com/jeffreyguenther">@jeffreyguenther</a> who
shared his experience of using ActiveStorage on his projects with me.</p>


  </div>

  <div id="disqus_thread"></div>
  <script>
  /**
  * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
  */
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');

  s.src = '//mybread.disqus.com/embed.js';

  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Jason Kim</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Jason Kim</li>
          <li><a href="mailto:iamjsonkim@gmail.com">iamjsonkim@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/serv"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">serv</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/jasoki"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">jasoki</span></a>

          </li>
          

          
          <li>
            <a href="https://www.linkedin.com/in/jason-kim-a2b97b6">
  <span class="icon icon--linkedin"><?xml version="1.0" encoding="utf-8"?>


<!-- The icon can be used freely in both personal and commercial projects with no attribution required, but always appreciated. 
You may NOT sub-license, resell, rent, redistribute or otherwise transfer the icon without express written permission from iconmonstr.com -->


<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"

	 width="512px" height="512px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve">

<path id="linkedin-icon" d="M150.65,100.682c0,27.992-22.508,50.683-50.273,50.683c-27.765,0-50.273-22.691-50.273-50.683

	C50.104,72.691,72.612,50,100.377,50C128.143,50,150.65,72.691,150.65,100.682z M143.294,187.333H58.277V462h85.017V187.333z

	 M279.195,187.333h-81.541V462h81.541c0,0,0-101.877,0-144.181c0-38.624,17.779-61.615,51.807-61.615

	c31.268,0,46.289,22.071,46.289,61.615c0,39.545,0,144.181,0,144.181h84.605c0,0,0-100.344,0-173.915

	s-41.689-109.131-99.934-109.131s-82.768,45.369-82.768,45.369V187.333z" fill="#e0e0e0" />

</svg>

</span>
  <span class="username">Jason Kim</span>
</a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writings on software and other topics
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
