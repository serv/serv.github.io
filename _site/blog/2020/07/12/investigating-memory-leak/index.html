<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Investigating Memory Leak in a Node.js Application</title>
  <meta name="description" content="I was struck with a memory leak problem in Node.js application recently.It is not fun dealing with memory leak problems. Unlike other typical bugs youface ca...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/blog/2020/07/12/investigating-memory-leak/">
  <link rel="alternate" type="application/rss+xml" title="Jason Kim" href="http://localhost:4000/feed.xml">
</head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28018879-10', 'auto');
  ga('send', 'pageview');

</script>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Jason Kim</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Investigating Memory Leak in a Node.js Application</h1>
    <p class="post-meta"><time datetime="2020-07-12T21:17:11-07:00" itemprop="datePublished">Jul 12, 2020</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I was struck with a memory leak problem in Node.js application recently.
It is not fun dealing with memory leak problems. Unlike other typical bugs you
face caused by errors in syntax of your code or failures in upstream services,
a memory leak problem defies conventional approaches to squashing the bug.
You need to use unusual tools you don’t normally use and you typically will
need more time to solve the problem.</p>

<p><img src="https://i.imgur.com/Skr597z.png" alt="memory leak" /></p>

<p>Let’s evaluate some some approaches and tools that you can use to resolve a
memory leak issue in Node.js Applications.</p>

<h2 id="heapdump-npm-package">Heapdump NPM package</h2>

<p><a href="https://github.com/bnoordhuis/node-heapdump">node-heapdump</a> is an easy to use
NPM package that generates a V8 heap dump of your Node.js application.
You can examine the heap dump with the Developer Tool in the Chrome browser.</p>

<ul>
  <li>Pros
    <ul>
      <li>Simple setup</li>
      <li>Can integrate with your Node.js application and create <a href="https://github.com/goldbergyoni/nodebestpractices/blob/master/sections/production/createmaintenanceendpoint.md">a maintenance endpoint</a></li>
      <li>Easily inspect the V8 heap dump using Chrome Developer Tool</li>
    </ul>
  </li>
  <li>Cons
    <ul>
      <li>Only useable if the app is still responsive</li>
    </ul>
  </li>
</ul>

<p>My Node.js app was unresponsive because it was executing a blocking function.
The blocking function was preventing the Node.js app from accepting any requests to create a heapdump.</p>

<p>As you can see, there’s no silver bullet to investigating and resolving a memory
leak problem. The essence of solving memory leak problem can be described as
simply as 1) get a heap dump 2) inspect the heap dump 3) identify the cause of the
most memory exhausting object creation.
However, there are many different tools and techniques you to solve the
problem and no single way will present a simple solution. Let’s continue evaluating
other tools.</p>

<h2 id="gcore--mdb-on-solaris">gcore + MDB on Solaris</h2>

<p>4 years ago, I solved <a href="http://blog.jasonkim.ca/blog/2016/06/03/fixing-memory-leak-on-production-node-application/">another memory leak problem</a>
in Node.js application. At that
time, the tool that allows you to inspect memory heap dump of a process, llnode
(I’ll present this tool last), wasn’t as mature as it is today. And at that time,
I could not use it with the heap dump. I had to use a tool called <a href="https://docs.oracle.com/cd/E18752_01/html/816-5041/intro-27.html">MDB</a> with <a href="https://man7.org/linux/man-pages/man1/gcore.1.html">gcore</a>.</p>

<ul>
  <li>Pros
    <ul>
      <li>You can run gcore even when the Node.js app is unresponsive</li>
    </ul>
  </li>
  <li>Cons
    <ul>
      <li>Difficult setup. You need Solaris to run MDB. To learn more, you can read
this <a href="http://blog.jasonkim.ca/blog/2016/06/03/fixing-memory-leak-on-production-node-application/">previous blog post</a> I wrote on this topic.</li>
    </ul>
  </li>
</ul>

<p>Because setting up Solaris is too cumbersome, I decided to explore using llnode
to inspect the gcore heap dump.</p>

<h2 id="gcore--llnode">gcore + llnode</h2>

<p><a href="https://github.com/nodejs/llnode">llnode</a> is another tool for inspecting gcore heap dump.
I decided to use llnode because I was able to install the tool inside a docker container,
which hosts my Node.js app.</p>

<ul>
  <li>Pros
    <ul>
      <li>Moderately easy to setup.</li>
      <li>llnode is easy to use.</li>
      <li>You can run gcore even when the Node.js app is unresponsive.</li>
    </ul>
  </li>
</ul>

<p>I could not find notable reasons why I shouldn’t use gcore + llnode to investigate
the memory issue.</p>

<p>Here are the steps needed to prepare the tools needed to perform your investigation.
I am running Node.js application inside Ubuntu 18 Docker container.</p>

<ul>
  <li>Go inside the Docker container running the Node.js app.
<code class="highlighter-rouge">docker exec -it app_name bash</code></li>
  <li>Update Ubuntu
<code class="highlighter-rouge">apt-get update</code></li>
  <li>
    <p>Install lldb
<code class="highlighter-rouge">apt install lldb-4.0 liblldb-4.0-dev</code></p>

    <p>You might see an warning message that reads</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mount: permission denied
update-binfmts: warning: Couldn't mount the binfmt_misc filesystem on /proc/sys/fs/binfmt_misc.
</code></pre></div>    </div>

    <p><a href="https://stackoverflow.com/questions/54951262/binfmt-misc-problems-in-ubuntu18-04-under-docker">You can safely ignore it for our purpose.</a></p>
  </li>
  <li>Install node-gyp
<code class="highlighter-rouge">npm i node-gyp</code></li>
  <li>Install llnode
<code class="highlighter-rouge">npm install llnode</code></li>
  <li>Install gcore
<code class="highlighter-rouge">apt-get install gdb</code></li>
  <li>Run <code class="highlighter-rouge">top</code> to identify the process number for your Node.js app.
<code class="highlighter-rouge">36 root 20 0 5700608 4.482g 29724 R 99.7 29.7 100:45.02 node /usr/src/a</code>
In this case, the process number is 36.</li>
  <li>
    <p>Run gcore on the process.
<code class="highlighter-rouge">gcore 36</code>
You might see this error.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ptrace: Operation not permitted.
You can't do that without a process to debug.
The program is not being run.
gcore: failed to create core.36
</code></pre></div>    </div>
  </li>
  <li>
    <p>To solve the problem in 8, you need to add this to your docker-compose file.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cap_add:
- SYS_PTRACE
</code></pre></div>    </div>

    <p>This is <a href="https://jvns.ca/blog/2020/04/29/why-strace-doesnt-work-in-docker/">a good blog post</a> on why you need if you are curious.</p>
  </li>
  <li>Try step 8 again. gcore should work now.</li>
  <li>Inspect the core dump with llnode
<code class="highlighter-rouge">./node_modules/.bin/llnode node -c core.36</code></li>
</ul>

<p>The process of investigation goes something like this.</p>

<ul>
  <li>
    <p>Run <code class="highlighter-rouge">v8 findjsobjects</code> inside llnode to determine what object is causing the memory leak. You might be wondering how does one tell which object is causing the memory leak.
There are mainly two ways to nail down the object causing the memory leak.</p>

    <ul>
      <li>When you have a rapidly growing memory leak, your heap dump presents an extreme version of <a href="https://en.wikipedia.org/wiki/Pareto_principle">Pareto principle</a>. The object will present itself to be occupying a vast majority of memory will be where you will want to investigate. Here’s my result of <code class="highlighter-rouge">v8 findjsobjects</code> demonstrating this effect.</li>
    </ul>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
Instances      Size    Name
        109       3488 ContextifyScript
        138       9936 I
        187      13464 (ArrayBufferView)
        213      11928 NodeError
        220      17600 Layer
        226      12656 Node
        226      14456 Entry
        231      11096 Source
        273       6552 CallSite
       3129     250240 Module
      10930     961840 Tok
      16150    1033480 Loc
      30496     975872 (Array)
     336951    8086824 RowDataPacket
    8901702  286210248 Object
   11881688    3728960 (String)
</code></pre></div>    </div>
  </li>
  <li>
    <p>When you have a much more slowly growing memory leak, you can’t easily tell what
JS object is responsible for the memory leak. In this case, you have to take 2 heap
dumps over a period time and see if you see any growth in some JS objects. The
object growing in the number of instances will be the cause of your memory leak.</p>
  </li>
  <li>
    <p>Generic JS primitives (String, Number, Array etc) and Objects are unactionable. Determine what is the JS
object that is not JS primitives and Objects which appears to be cause
of the memory leak? In my case, it is <code class="highlighter-rouge">RowDataPacket</code>.</p>
  </li>
  <li>
    <p>By padding logs and metrics around suspicious code, determine where in your code
causes the <code class="highlighter-rouge">RowDataPacket</code> object to be created in such number.</p>
  </li>
</ul>

<p>You’ve now found the cause of the memory leak. Unfortunately, finding the cause of the memory leak is not sufficient to resolving the actual memory leak issue.
You still have to apply a remedy to mitigate the cause of the memory leak.
And for that step, good luck.</p>

  </div>

  <div id="disqus_thread"></div>
  <script>
  /**
  * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
  */
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');

  s.src = '//mybread.disqus.com/embed.js';

  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Jason Kim</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Jason Kim</li>
          <li><a href="mailto:iamjsonkim@gmail.com">iamjsonkim@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/serv"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">serv</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/jasoki"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">jasoki</span></a>

          </li>
          

          
          <li>
            <a href="https://www.linkedin.com/in/jason-kim-a2b97b6">
  <span class="icon icon--linkedin"><?xml version="1.0" encoding="utf-8"?>


<!-- The icon can be used freely in both personal and commercial projects with no attribution required, but always appreciated. 
You may NOT sub-license, resell, rent, redistribute or otherwise transfer the icon without express written permission from iconmonstr.com -->


<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"

	 width="512px" height="512px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve">

<path id="linkedin-icon" d="M150.65,100.682c0,27.992-22.508,50.683-50.273,50.683c-27.765,0-50.273-22.691-50.273-50.683

	C50.104,72.691,72.612,50,100.377,50C128.143,50,150.65,72.691,150.65,100.682z M143.294,187.333H58.277V462h85.017V187.333z

	 M279.195,187.333h-81.541V462h81.541c0,0,0-101.877,0-144.181c0-38.624,17.779-61.615,51.807-61.615

	c31.268,0,46.289,22.071,46.289,61.615c0,39.545,0,144.181,0,144.181h84.605c0,0,0-100.344,0-173.915

	s-41.689-109.131-99.934-109.131s-82.768,45.369-82.768,45.369V187.333z" fill="#e0e0e0" />

</svg>

</span>
  <span class="username">Jason Kim</span>
</a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writings on software and other topics
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
