{"pageProps":{"post":{"title":"Deploy Rails 7.2.1 + Managed Postgresql App to Azure Using Kamal 2.1.1","createdAt":"2024-11-08T23:51:07-08:00","categories":[],"slug":"deploy-rails-721-managed-postgresql-app-to-azure-using-kamal-211","fullPath":"/Users/jasonkim/projects/websites/serv.github.io/_posts/2024-11-09-deploy-rails-721-postgresql-app-to-azure-using-kamal.md","content":"<p>Let's setup a Rails app that uses Postgresql as the DB and deploy it to Azure using Kamal. Note that the Postgresql in production environment will be using the managed Postgresql instance in Azure.</p>\n<h1>1. Settings up Rails App</h1>\n<h2>1.1 Create a new Rails app</h2>\n<p><code>$ rails new rails-pg-kamal-deployed-to-azure --minimal --database=postgresql</code></p>\n<h2>1.2 Add a scaffold</h2>\n<ul>\n<li><code>$ cd rails-pg-kamal-deployed-to-azure</code></li>\n<li><code>$ rails g scaffold post title:string content:text</code></li>\n</ul>\n<h2>1.3 Locally set up Postgresql for Testing</h2>\n<ul>\n<li>Create <code>docker-compose.development.yml</code></li>\n</ul>\n<pre><code class=\"language-yml\">version: '3.8'\nservices:\n  db:\n    image: postgres:16.2-alpine\n    container_name: rails-pg-kamal-deployed-to-azure-development-db\n    restart: always\n    environment:\n      - POSTGRES_USER=postgres\n      - POSTGRES_PASSWORD=postgres\n      - POSTGRES_DB=rails_pg_kamal_deployed_to_azure_development\n    ports:\n      - '5442:5432'\n    volumes:\n      - db:/var/lib/postgresql/data\nvolumes:\n  db:\n    driver: local\n</code></pre>\n<ul>\n<li>\n<p>Note the username, password, db name, and the port above</p>\n</li>\n<li>\n<p><code>config/database.yml</code></p>\n</li>\n</ul>\n<pre><code class=\"language-yaml\">development:\n  &#x3C;&#x3C;: *default\n  database: rails_pg_kamal_deployed_to_azure_development\n  port: 5442\n  host: localhost\n  username: postgres\n  password: postgres\n</code></pre>\n<ul>\n<li>Start PG DB locally<ul>\n<li><code>$ docker-compose -f docker-compose.development.yml up --build</code></li>\n</ul></li>\n</ul>\n<h2>1.4 Run migration</h2>\n<ul>\n<li>You can omit running <code>$ rails db:create</code> because database will be created by starting docker-compose</li>\n<li>Run <code>$ rails db:migrate</code> </li>\n</ul>\n<h2>1.5 Add Routes</h2>\n<ul>\n<li><code>routes.rb</code></li>\n</ul>\n<pre><code class=\"language-ruby\">root \"posts#index\"\n</code></pre>\n<h2>1.6 Start server locally</h2>\n<ul>\n<li><code>$ ./bin/dev</code></li>\n<li>Go to localhost:3000</li>\n</ul>\n<h1>2. Azure</h1>\n<h2>2.1 Everything except Postgresql</h2>\n<p>Please follow <a href=\"https://blog.jasonkim.ca/post/deploy-rails-721-sqlite3-app-to-azure-using-kamal\">the instructions here</a>.</p>\n<p>You may want to skip \"2.2 Create Container Registry\", if you already have a container registry to use.</p>\n<h2>2.2 Postgresql</h2>\n<h3>2.2.1 Setting up Basics</h3>\n<ol>\n<li>Go <a href=\"https://portal.azure.com/#view/Microsoft_Azure_Marketplace/PlusNew.ReactView/package/hub/additionalConfig~/%7B%7D/selectedMenuItemId/undefined/createLanding/undefined\">\"Create a resource\" page</a></li>\n<li>In the left hand side bar, select \"Databases\".</li>\n<li>Click \"Create\" for \"Azure Database for PostgreSQL\"</li>\n<li>Select the Subscription and Resource Group</li>\n<li>Under Server Details, provide info like below.</li>\n</ol>\n<ul>\n<li><img src=\"/images/2024/10/azure-pg-server-details.png\"></li>\n</ul>\n<ol start=\"6\">\n<li>Make sure to Click \"Configure server\" and size down the DB server appropriately.</li>\n</ol>\n<ul>\n<li><img src=\"/images/2024/10/azure-pg-server-config.png\"></li>\n</ul>\n<ol start=\"7\">\n<li>Provide info to setup \"Authentication\" for the db.</li>\n</ol>\n<ul>\n<li><img src=\"/images/2024/10/azure-pg-auth.png\"></li>\n</ul>\n<ol start=\"8\">\n<li>Click \"Review + create\".</li>\n</ol>\n<p>PG</p>\n<ul>\n<li>pgadminops</li>\n<li>8132a28d96bc@</li>\n</ul>\n<h3>2.2.2 Networking</h3>\n<ul>\n<li>Setup the Networking setup like below</li>\n<li><img src=\"/images/2024/10/azure-pg-server-network.png\"></li>\n<li>Click \"Create\".</li>\n</ul>\n<h3>2.2.3 Dealing with <code>extension \"plpgsql\" is not allow-listed for \"azure_pg_admin\" users in Azure Database for PostgreSQL</code> error.</h3>\n<p>When you use Azure Database for PostgreSQL, you will see the following error.</p>\n<pre><code> ERROR 2024-10-16T06:56:56.367508062Z bin/rails aborted!\n2024-10-16T06:56:56.367929864Z ActiveRecord::StatementInvalid: PG::FeatureNotSupported: ERROR:  extension \"plpgsql\" is not allow-listed for \"azure_pg_admin\" users in Azure Database for PostgreSQL (ActiveRecord::StatementInvalid)\n2024-10-16T06:56:56.367975864Z HINT:  to learn how to allow an extension or see the list of allowed extensions, please refer to https://go.microsoft.com/fwlink/?linkid=2281561\n2024-10-16T06:56:56.368497566Z /rails/db/schema.rb:15:in `block in &#x3C;top (required)>'\n2024-10-16T06:56:56.368509766Z /rails/db/schema.rb:13:in `&#x3C;top (required)>'\n2024-10-16T06:56:56.368641767Z\n2024-10-16T06:56:56.368669567Z Caused by:\n2024-10-16T06:56:56.368799368Z PG::FeatureNotSupported: ERROR:  extension \"plpgsql\" is not allow-listed for \"azure_pg_admin\" users in Azure Database for PostgreSQL (PG::FeatureNotSupported)\n2024-10-16T06:56:56.368809368Z HINT:  to learn how to allow an extension or see the list of allowed extensions, please refer to https://go.microsoft.com/fwlink/?linkid=2281561\n2024-10-16T06:56:56.368998368Z /rails/db/schema.rb:15:in `block in &#x3C;top (required)>'\n2024-10-16T06:56:56.369025368Z /rails/db/schema.rb:13:in `&#x3C;top (required)>'\n2024-10-16T06:56:56.369153969Z Tasks: TOP => db:prepare\n2024-10-16T06:56:56.369269569Z (See full trace by running task with --trace)\n2024-10-16T06:57:00.413100892Z bin/rails aborted!\n</code></pre>\n<ol>\n<li>Go to <code>Azure Database for PostgreSQL</code></li>\n<li>Select the PG database</li>\n<li>Click Settings > Server Parameters</li>\n<li>Search for <code>azure.extensions</code>.</li>\n<li>Click <code>Value</code> column</li>\n<li>Check <code>PLPGSQL</code>.</li>\n</ol>\n<ul>\n<li><img src=\"/images/2024/10/pg-azure-exte.png\"></li>\n</ul>\n<p>See <a href=\"https://stackoverflow.com/a/74002100/536890\">link</a> for more info.</p>\n<h1>3. Setting up Kamal 2 for Rails</h1>\n<h2>3.1. Follow these steps here</h2>\n<p>Follow Step 3 in the following <a href=\"https://blog.jasonkim.ca/post/deploy-rails-721-sqlite3-app-to-azure-using-kamal\">link</a>, but you can skip Step 3.1.</p>\n<h2>3.2. Update <code>.kamal/secrets</code></h2>\n<ul>\n<li>Add secrets in <code>.kamal/secrets</code>.</li>\n</ul>\n<pre><code>RAILS_MASTER_KEY=$(cat config/master.key)\nKAMAL_REGISTRY_PASSWORD=...\nPOSTGRES_PASSWORD=...\n</code></pre>\n<h2>3.3. Update <code>config/database.yml</code></h2>\n<pre><code class=\"language-yml\">production:\n  &#x3C;&#x3C;: *default\n  database: rails_pg_kamal_deployed_to_azure_production\n  username: pgadminops\n  password: &#x3C;%= ENV[\"POSTGRES_PASSWORD\"] %>\n  host: &#x3C;%= ENV[\"DB_HOST\"] %>\n</code></pre>\n<h2>3.4. Update <code>config/deploy.yml</code></h2>\n<ul>\n<li>Comment out <code>proxy.host</code>.</li>\n</ul>\n<p>Example:</p>\n<pre><code class=\"language-yml\">&#x3C;% require \"dotenv\"; Dotenv.load(\".env\") %>\n\n# Name of your application. Used to uniquely configure containers.\nservice: rails-pg-kamal-deployed-to-azure\n\n# Name of the container image.\nimage: serv/rails-pg-kamal-deployed-to-azure\n\n# Deploy to these servers.\nservers:\n  web:\n    hosts:\n      - x.y.z.a  \n  # job:\n  #   hosts:\n  #     - 192.168.0.1\n  #   cmd: bin/jobs\n\n# Enable SSL auto certification via Let's Encrypt (and allow for multiple apps on one server).\n# Set ssl: false if using something like Cloudflare to terminate SSL (but keep host!).\nproxy:\n  ssl: false\n  # host: 52.146.91.48\n  # kamal-proxy connects to your container over port 80, use `app_port` to specify a different port.\n  app_port: 3000\n  healthcheck:\n    path: /up\n\n# Credentials for your image host.\nregistry:\n  # Specify the registry server, if you're not using Docker Hub\n  # server: registry.digitalocean.com / ghcr.io / ...\n  server: xyz.azurecr.io\n  username: xyz\n\n  # Always use an access token rather than real password (pulled from .kamal/secrets).\n  password:\n    - KAMAL_REGISTRY_PASSWORD\n\n# Configure builder setup.\nbuilder:\n  # context: .\n  arch: amd64\n# Inject ENV variables into containers (secrets come from .kamal/secrets).\n#\nenv:\n  clear:\n    DB_HOST: &#x3C;%= ENV[\"DB_HOST\"] %>\n  secret:\n    - RAILS_MASTER_KEY\n    - KAMAL_REGISTRY_PASSWORD\n    - POSTGRES_PASSWORD\n\n# Aliases are triggered with \"bin/kamal &#x3C;alias>\". You can overwrite arguments on invocation:\n# \"bin/kamal logs -r job\" will tail logs from the first server in the job section.\n#\n# aliases:\n#   shell: app exec --interactive --reuse \"bash\"\n\n# Use a different ssh user than root\nssh:\n  user: azureuser\n</code></pre>\n<h2>3.5 Update <code>config/environments/production.rb</code></h2>\n<p>Comment out <code>force_ssl</code>.</p>\n<pre><code class=\"language-ruby\"># config.force_ssl = true\n</code></pre>\n<h2>3.6. Update <code>config/routes.rb</code></h2>\n<pre><code class=\"language-ruby\">root \"posts#index\"\n</code></pre>\n"}},"__N_SSG":true}