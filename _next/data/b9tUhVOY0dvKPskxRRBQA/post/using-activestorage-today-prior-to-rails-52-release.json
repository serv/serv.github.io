{"pageProps":{"post":{"title":"Using ActiveStorage Today (prior to Rails 5.2 release)","createdAt":"2017-11-13T00:00:00-08:00","categories":["ruby on rails"],"slug":"using-activestorage-today-prior-to-rails-52-release","fullPath":"/home/jason/projects/websites/serv.github.io/_posts/2017-11-13-Using-ActiveStorage-Today.md","content":"<p><a href=\"http://weblog.rubyonrails.org/2017/7/15/this-week-in-rails-active-storage-telling-secrets-and-time-travelling/\">DHH announced earlier in the year that Rails 5.2 will have a brand new component called ActiveStorage</a>.\nActiveStorage will manage user uploads such as photos directly by Rails.</p>\n<p>Since then, a lot of progress has been made to integrate ActiveStorage to\nRails, and you can actually use ActiveStorage today. This blog will explore\nthe how you can update your Rails app to use ActiveStorage.</p>\n<p><strong>Warning!</strong> You will be using the bleeding edge version of Rails and\nthere may be unforseen problems caused by it.</p>\n<h2>Setting up ActiveStorage for Rails</h2>\n<h4>1. If you are using Rails version before 5.1.14, update Rails to 5.1.14 by updating your Gemfile</h4>\n<p>{% highlight ruby %}\ngem 'rails', '~> 5.1', '>= 5.1.4'\n{% endhighlight %}</p>\n<h4>2. Run <code>$ bundle update rails</code></h4>\n<h4>3. Run <code>$ rails app:update</code> and resolve any code differences.</h4>\n<h4>4. Test that updating to <code>5.1.14</code> went ok.</h4>\n<h4>5. Now we want to update rails to the latest bleeding edge version. In the</h4>\n<p><code>Gemfile</code>, add the following lines.\n{% highlight ruby %}\ngit_source(:github) do |repo_name|\nrepo_name = \"#{repo_name}/#{repo_name}\" unless repo_name.include?(\"/\")\n\"<a href=\"https://github.com/#%7Brepo_name%7D.git%22\">https://github.com/#{repo_name}.git\"</a>\nend\n...\ngem 'rails', github: 'rails/rails'\ngem 'arel', git: '<a href=\"https://github.com/rails/arel.git&#x27;\">https://github.com/rails/arel.git'</a>\ngem 'bootsnap', '~> 1.1', '>= 1.1.5', require: false\n{% endhighlight %}</p>\n<h4>6. Run <code>$ bundle update rails</code></h4>\n<h4>7. <code>$ bundle exec rails -v</code> should display the bleeding edge version,</h4>\n<p><code>Rails 5.2.0.alpha</code>.</p>\n<h4>8. Update the application configs. Run <code>$ bundle exec rails app:update</code>.</h4>\n<h4>9. When you run, <code>$ ./bin/rails --tasks</code>, you should see,</h4>\n<p><code>rails active_storage:install</code> as an available task.</p>\n<h4>10. Run <code>$ ./bin/rails active_storage:install</code>. This should generate a migration file.</h4>\n<h4>11. Run <code>$ ./bin/rails db:migrate</code>. Now our sqlite db should be ready to support ActiveStorage.</h4>\n<h2>A simple image uploading example using ActiveStorage</h2>\n<p>Up until now, we've been preparing Rails application to support ActiveStorage.\nNow that the application is equipped with ActiveStorage, let us build a\nsimple feature that allows us to create a post with images\nthat uses ActiveStorage.</p>\n<h4>1. Generate post model. <code>$ ./bin/rails g model post</code>.</h4>\n<h4>2. Let's add two columns to post table, <code>title</code>, <code>body</code> in the migration file.</h4>\n<p>{% highlight ruby %}</p>\n<h1>db/migrate/20171114063756_create_posts.rb</h1>\n<p>class CreatePosts &#x3C; ActiveRecord::Migration[5.2]\ndef change\ncreate_table :posts do |t|\nt.string :title\nt.text :body</p>\n<pre><code> t.timestamps\nend\n</code></pre>\n<p>  end\nend\n{% endhighlight %}</p>\n<h4>3. Let's create a controller for posts resource.</h4>\n<p><code>$ ./bin/rails g controller posts</code></p>\n<h4>4. And add posts resources routes in the <code>config/routes.rb</code>.</h4>\n<p>{% highlight ruby %}\nRails.application.routes.draw do\nresources :posts\nend\n{% endhighlight %}</p>\n<h4>5. We need to associate post with images.</h4>\n<p>{% highlight ruby %}\nclass Post &#x3C; ApplicationRecord\nhas_many_attached :images\nend\n{% endhighlight %}</p>\n<h4>6. Let's add code for index, show and create actions.</h4>\n<p>{% highlight ruby %}</p>\n<h1>app/controllers/posts_controller.rb</h1>\n<p>class PostsController &#x3C; ApplicationController</p>\n<h1>we will display post form here</h1>\n<p>  def index\n@post = Post.new\nend</p>\n<h1>we will create post here</h1>\n<p>  def create\npost = Post.create! params.require(:post).permit(:title, :body)\npost.images.attach(params[:post][:images])\nredirect_to post\nend</p>\n<h1>we will display post with photo</h1>\n<p>  def show\n@post = Post.find(params[:id])\nend\nend\n{% endhighlight %}</p>\n<h4>7. Add the index view for the post with the following code. This will display upload form on localhost:3000/posts page.</h4>\n<p>{% highlight erb %}</p>\n<h1>app/views/posts/index.html.erb</h1>\n<p>&#x3C;%= form_with model: @post, local: true do |form| %>\n&#x3C;%= form.text_field :title, placeholder: \"Title\" %><br>\n&#x3C;%= form.text_area :body %><br><br>\n&#x3C;%= form.file_field :images, multiple: true %><br>\n&#x3C;%= form.submit %>\n&#x3C;% end %>\n{% endhighlight %}</p>\n<h4>8. Now let's add a view for show post.</h4>\n<p>{% highlight erb %}</p>\n<h1>app/views/posts/show.html.erb</h1>\n<p>&#x3C;%= image_tag @post.images.first %>\n{% endhighlight %}</p>\n<h4>9. Try submitting a photo and you will see the show view displays the image you just submitted.</h4>\n<p>The image is currently stored locally in a\ndirectory called <code>storage</code> in the app root level. But you can configure\nthis to push the files to cloud file storage systems like AWS S3, Google Cloud\nand Azure.</p>\n<p>As you can see, ActiveStorage presents a simplied file management system\nthat is well integrated with Rail's ActiveRecord component.\nAs ActiveStorage matures, we should see majority of\nfile management use cases being covered by it.\nWhile there are other file management systems out there for Rails, I suggest that\nyou consider ActiveStorage before you explore other options.</p>\n<p>Also check out <a href=\"https://github.com/rails/rails/blob/master/activestorage/README.md\">the documentation on ActiveStorage</a>.</p>\n<p>You can see the final working code on the <a href=\"https://github.com/serv/rails-alpha-activestorage-example\">github repo</a>.</p>\n<p>I wanna thank <a href=\"https://twitter.com/jeffreyguenther\">@jeffreyguenther</a> who\nshared his experience of using ActiveStorage on his projects with me.</p>\n"}},"__N_SSG":true}